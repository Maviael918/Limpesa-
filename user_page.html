<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mvlSystem - Limpeza</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.lordicon.com/lordicon.js"></script>
</head>
<body>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            if (typeof window.supabaseClient === 'undefined') {
                let attempts = 0;
                const maxAttempts = 20;
                const interval = setInterval(async () => {
                    if (typeof window.supabaseClient !== 'undefined') {
                        clearInterval(interval);
                        await checkAuthAndRole();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        console.error('Supabase client não inicializado. Redirecionando para login.');
                        window.location.href = 'login.html';
                    }
                    attempts++;
                }, 100);
            } else {
                await checkAuthAndRole();
            }

            async function checkAuthAndRole() {
                const { data: { session }, error: sessionError } = await window.supabaseClient.auth.getSession();
                if (sessionError || !session) {
                    window.location.href = 'login.html';
                    return;
                }

                let storedRole = null;
                try { storedRole = localStorage.getItem('ckpActiveRole'); } catch (_) {}
                storedRole = storedRole ? storedRole.toString().trim().toLowerCase() : null;

                let allowed = storedRole && ['limpeza', 'admin'].includes(storedRole);

                if (!allowed) {
                    const { data: profile, error: profileError, status } = await window.supabaseClient
                        .from('profiles')
                        .select('role')
                        .eq('id', session.user.id)
                        .maybeSingle();

                    if (profileError && status !== 406) {
                        console.error('Erro ao buscar perfil para limpeza:', profileError);
                    }

                    const roleDb = profile?.role ? profile.role.toString().trim().toLowerCase() : null;
                    allowed = roleDb && ['limpeza', 'admin'].includes(roleDb);
                }

                if (!allowed) {
                    alert('Acesso negado. Você não tem permissão para acessar esta página.');
                    window.location.href = 'login.html';
                    return;
                }
            }
        });
    </script>

    <div class="main-content" style="margin-left: 0;">
        <div class="page active">
            <h1>Área de Limpeza</h1>
            <div class="card">
                <div class="form-actions" style="display:flex;justify-content:flex-end;margin-bottom:16px;gap:8px;">
                    <button type="button" id="limpeza-configure-products" class="btn btn-secondary">
                        <lord-icon src="https://cdn.lordicon.com/gqdnbnwt.json" trigger="hover" colors="primary:#ffffff" style="width:22px;height:22px;margin-right:6px;"></lord-icon>
                        Configurar Produtos
                    </button>
                    <button type="button" id="limpeza-select-school-btn" class="btn">
                        <lord-icon src="https://cdn.lordicon.com/nehsutef.json" trigger="hover" colors="primary:#ffffff" style="width:22px;height:22px;margin-right:6px;"></lord-icon>
                        Selecionar Escola
                    </button>
                    <button type="button" id="limpeza-open-product-modal" class="btn btn-primary">
                        <lord-icon src="https://cdn.lordicon.com/cllunfud.json" trigger="hover" colors="primary:#ffffff" style="width:22px;height:22px;margin-right:6px;"></lord-icon>
                        Adicionar Produtos
                    </button>
                </div>

                <div class="order-meta" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:16px;">
                    <div class="info-card">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <lord-icon src="https://cdn.lordicon.com/nocovwne.json" trigger="hover" colors="primary:#0b7285" style="width:28px;height:28px;"></lord-icon>
                            <strong>Setor Selecionado</strong>
                        </div>
                        <span id="limpeza-selected-sector">-</span>
                    </div>
                    <div class="info-card">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <lord-icon src="https://cdn.lordicon.com/sbiheqdr.json" trigger="hover" colors="primary:#0b7285" style="width:28px;height:28px;"></lord-icon>
                            <strong>Escola Selecionada</strong>
                        </div>
                        <span id="limpeza-selected-school">Nenhuma selecionada</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="limpeza-observations">Observações</label>
                    <textarea id="limpeza-observations" placeholder="Observações sobre o pedido"></textarea>
                </div>

                <table id="limpeza-order-table" class="table" style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #dee2e6;">Produto</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #dee2e6;">Quantidade</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #dee2e6;">Unidade</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #dee2e6;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="limpeza-order-tbody">
                        <tr>
                            <td colspan="4" class="empty-message">Nenhum produto adicionado. Clique em "Adicionar Produtos" para começar.</td>
                        </tr>
                    </tbody>
                </table>

                <p id="limpeza-empty-message" class="empty-message" style="display:none;">Nenhum produto adicionado. Clique em "Adicionar Produtos" para começar.</p>

                <div class="form-actions" style="display:flex;justify-content:flex-end;margin-top:16px;gap:8px;">
                    <button type="button" id="limpeza-clear-order" class="btn btn-secondary">
                        <lord-icon src="https://cdn.lordicon.com/rslnizbt.json" trigger="hover" colors="primary:#ffffff" style="width:22px;height:22px;margin-right:6px;"></lord-icon>
                        Limpar Pedido
                    </button>
                    <button type="button" id="limpeza-print-order" class="btn btn-info">
                        <lord-icon src="https://cdn.lordicon.com/mxdxazea.json" trigger="hover" colors="primary:#ffffff" style="width:22px;height:22px;margin-right:6px;"></lord-icon>
                        Imprimir Pedido
                    </button>
                    <button type="button" id="limpeza-generate-pdf" class="btn btn-success">
                        <lord-icon src="https://cdn.lordicon.com/pithnlch.json" trigger="hover" colors="primary:#ffffff" style="width:22px;height:22px;margin-right:6px;"></lord-icon>
                        Gerar PDF
                    </button>
                </div>
            </div>

            <div class="card" style="margin-top:24px;">
                <div class="order-history-header" style="margin-bottom:12px;">
                    <h2>Histórico de Pedidos</h2>
                    <div class="order-history-actions">
                        <div class="order-history-search">
                            <input type="search" id="limpeza-history-search-input" placeholder="Buscar escola no histórico" aria-label="Buscar escola no histórico">
                            <button type="button" id="limpeza-history-search-btn" class="icon-button" aria-label="Buscar no histórico"></button>
                        </div>
                        <button type="button" id="limpeza-print-latest" class="btn btn-secondary btn-sm">Imprimir</button>
                    </div>
                </div>
                <table class="table" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #dee2e6;">Escola</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #dee2e6;">Data</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #dee2e6;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="limpeza-history-tbody"></tbody>
                </table>
                <p id="limpeza-history-empty" class="empty-message" style="display:none;">Nenhum pedido registrado ainda.</p>
            </div>
        </div>
    </div>

    <div id="limpeza-school-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button" data-modal-close="limpeza-school-modal">&times;</span>
            <h2 style="display:flex;align-items:center;gap:8px;">
                <lord-icon src="https://cdn.lordicon.com/itnqiirz.json" trigger="loop" delay="2000" colors="primary:#0b7285" style="width:32px;height:32px;"></lord-icon>
                Selecionar Escola
            </h2>
            <div class="form-group">
                <label for="limpeza-modal-sector">Setor</label>
                <select id="limpeza-modal-sector">
                    <option value="">Todos os Setores</option>
                </select>
            </div>
            <div class="form-group">
                <label for="limpeza-modal-school">Escola</label>
                <select id="limpeza-modal-school" required>
                    <option value="">Selecione uma Escola</option>
                </select>
            </div>
            <div class="modal-actions" style="display:flex;justify-content:flex-end;gap:8px;">
                <button type="button" class="btn btn-secondary" data-modal-close="limpeza-school-modal">Cancelar</button>
                <button type="button" id="limpeza-confirm-school" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="limpeza-product-modal" class="modal" style="display:none;">
        <div class="modal-content modal-lg">
            <span class="close-button" data-modal-close="limpeza-product-modal">&times;</span>
            <h2 style="display:flex;align-items:center;gap:8px;">
                <lord-icon src="https://cdn.lordicon.com/cllunfud.json" trigger="loop" delay="2500" colors="primary:#0b7285" style="width:32px;height:32px;"></lord-icon>
                Adicionar Produtos de Limpeza
            </h2>
            <div class="form-group">
                <input type="search" id="limpeza-product-search" placeholder="Filtrar produtos por nome...">
            </div>
            <div class="table-responsive" style="max-height:380px; overflow:auto; border:1px solid #e9ecef; border-radius:8px;">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width:40px;"><input type="checkbox" id="limpeza-product-select-all"></th>
                            <th>Produto</th>
                            <th style="width:120px;">Quantidade</th>
                            <th style="width:120px;">Unidade</th>
                        </tr>
                    </thead>
                    <tbody id="limpeza-product-modal-tbody"></tbody>
                </table>
            </div>
            <p class="info-message" id="limpeza-product-modal-empty" style="display:none; margin-top:12px;">Nenhum produto encontrado. Cadastre novos produtos de limpeza no painel principal.</p>
            <div class="modal-actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
                <button type="button" class="btn btn-secondary" data-modal-close="limpeza-product-modal">Cancelar</button>
                <button type="button" id="limpeza-product-apply" class="btn btn-primary">Adicionar Selecionados</button>
            </div>
        </div>
    </div>

    <div id="limpeza-history-view-modal" class="modal" style="display:none;">
        <div class="modal-content modal-lg">
            <span class="close-button" data-modal-close="limpeza-history-view-modal">&times;</span>
            <h2 class="modal-title">
                <lord-icon src="https://cdn.lordicon.com/hyhnpiza.json" trigger="loop" delay="2100" colors="primary:#0b7285" style="width:28px;height:28px;"></lord-icon>
                Visualizar Pedido
            </h2>
            <div class="order-meta" style="margin-bottom:16px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));">
                <div class="info-card">
                    <strong>Data do Pedido</strong>
                    <span id="limpeza-view-date">-</span>
                </div>
                <div class="info-card">
                    <strong>Escola</strong>
                    <span id="limpeza-view-school">-</span>
                </div>
                <div class="info-card">
                    <strong>Setor</strong>
                    <span id="limpeza-view-sector">-</span>
                </div>
            </div>
            <div class="info-card" style="margin-bottom:16px;">
                <strong>Observações</strong>
                <span id="limpeza-view-observations">-</span>
            </div>
            <div class="table-responsive">
                <table class="table" style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #dee2e6;">Produto</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #dee2e6;">Quantidade</th>
                            <th style="text-align:left; padding:8px; border-bottom:1px solid #dee2e6;">Unidade</th>
                        </tr>
                    </thead>
                    <tbody id="limpeza-view-products">
                        <tr>
                            <td colspan="3" class="empty-message">Nenhum produto encontrado.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="limpeza-pdf-preview-modal" class="modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 9999;">
        <div class="modal-content" style="width: 90%; height: 90%; background: #fff; position: relative; padding: 8px; box-sizing: border-box;">
            <button type="button" id="limpeza-close-pdf-preview" class="close-button" data-modal-close="limpeza-pdf-preview-modal" style="position:absolute;top:8px;right:16px;">&times;</button>
            <iframe id="limpeza-pdf-preview-iframe" title="Pré-visualização do PDF" style="width:100%;height:100%;border:none;"></iframe>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/modules/pdf.js"></script>
    <script src="js/limpeza_page.js"></script>
</body>
</html>
